@if ( server; as s) {
<h2>
  {{ s.name }}
</h2>
<h4>Api Key: {{ s.apiKey }}</h4>
<hr />

<div class="row mb-2">
  <div class="col-md-4">
    <mat-card class="mb-3">
      <mat-card-header>
        <mat-card-title>Server Details</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p><b>Name:</b> {{ s.serverInfo.serverName }}</p>
        <p><b>Databases on server:</b> {{ s.serverInfo.databaseCount }}</p>
        <p><b>All databases size in GB:</b> {{ s.serverInfo.databaseSizeInGb }}</p>
        <p><b>CPU logical cores:</b> {{ s.serverInfo.logicalCpu }}</p>
        <p><b>Memory in GB:</b> {{ s.serverInfo.memoryInGb }}</p>
        <p><b>Architecture:</b> {{ s.serverInfo.is32Bit ? '32 BIT' : '64 BIT' }}</p>
        <p><b>Server last restart:</b> {{ s.serverInfo.lastRestartServer | date : 'short' }}</p>
        <p><b>SQL Server last restart:</b> {{ s.serverInfo.lastRestartSqlServer | date : 'short' }}</p>

        @if (s.serverInfo.defaultTraceContentInHours) {
        <p class="tooltip-indicator" matTooltip="Duration for retaining trace data used to monitor SQL Server activities and diagnose issues.">
          <b>Tracing since:</b> {{ convertHoursToDatetime(s.serverInfo.defaultTraceContentInHours) | date : 'short' }}
        </p>
        }
        <p><b>Edition:</b> {{ s.serverInfo.edition }}</p>
        <p><b>Version:</b> {{ s.serverInfo.versionDetails }}</p>
      </mat-card-content>
    </mat-card>

    @if (performanceStats && waitStats) {

    <mat-card class="mb-3">
      <mat-card-header>
        <mat-card-title class="tooltip-indicator" matTooltip="Metrics for the whole sql server that indicate the workload">Performance</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-tab-group>
          <mat-tab label="7 days">
            <canvas class="pt-3" baseChart [type]="'line'" [data]="lineChartPerformanceData" [options]="lineChartOptions" [legend]="true"> </canvas>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
    <mat-card class="mb-3">
      <mat-card-header>
        <mat-card-title class="tooltip-indicator" matTooltip="CPU Utilization in percents for the whole server">CPU Utilization</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-tab-group>
          <mat-tab label="7 days">
            <canvas class="pt-3" baseChart [type]="'line'" [data]="lineChartPerformanceCpuData" [options]="lineChartOptions" [legend]="true"> </canvas>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
    <mat-card class="mb-3">
      <mat-card-header>
        <mat-card-title
          class="tooltip-indicator"
          matTooltip="Every query on your server needs resources like CPU, RAM and needs to coehist with other queries. Here is what your server is bottlenecked by"
          >Server Bottlenecks</mat-card-title
        >
        <mat-card-subtitle>
          <button class="my-2" mat-button color="primary" (click)="getBottleneck()">What's my bottleneck?</button>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <mat-tab-group>
          <mat-tab label="7 days">
            <canvas class="pt-3" baseChart [type]="'line'" [data]="lineChartData" [options]="lineChartOptions" [legend]="true"> </canvas>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
    }
  </div>
  <div class="col-md-8">
    <mat-form-field class="full-width">
      <mat-label>Choose a date for monitoring server</mat-label>
      <input [formControl]="dateMonitoring.controls.date" matInput [matDatepicker]="picker" />
      <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker disabled="false"></mat-datepicker>
    </mat-form-field>

    @if (insights) {

    <mat-card class="mb-3">
      <mat-card-header>
        <mat-card-title>Server findings</mat-card-title>
      </mat-card-header>
      <mat-card-content class="mt-3 fit-paragraphs">
        <p *ngIf="insights.sqlServerCheck.cacheAndWaitStats.waitsClearedRecently">Wait stats were cleared.</p>
        <p
          *ngIf="insights.sqlServerCheck.cacheAndWaitStats.cacheClearedRecently"
          class="tooltip-indicator"
          matTooltip="Recent clearing of cache may lead to increased query compilation. Also top resource intensive queries might not be valid"
        >
          Plan cache was cleared.
        </p>
        <p
          *ngIf="insights.sqlServerCheck.cacheAndWaitStats.statisticsUpdatedRecently"
          class="tooltip-indicator"
          matTooltip="Frequent statistics updates may indicate high data volatility or inaccurate statistics, impacting query performance."
        >
          Statistics were updated.
        </p>

        <hr />

        <p
          class="success"
          *ngIf="
            insights.sqlServerCheck.cacheAndWaitStats.noSignificantWaitStats &&
            !insights.sqlServerCheck.cacheAndWaitStats.highWait &&
            !insights.sqlServerCheck.cacheAndWaitStats.poisonWaits &&
            !insights.sqlServerCheck.cacheAndWaitStats.poisonWaitsSerializableLocking
          "
          class="tooltip-indicator"
          matTooltip="This means your sql server isn't bottlenecked by any resource"
        >
          <b>No significant wait stats found.</b>
        </p>
        <p *ngIf="insights.sqlServerCheck.cacheAndWaitStats.highWait">
          High wait detected <b>{{ insights.sqlServerCheck.cacheAndWaitStats.highWaitType }}</b
          >. The last monitoring job took <b>{{ insights.sqlServerCheck.cacheAndWaitStats.highWaitJobTook }}</b> seconds and in that period it waited
          <b>{{ insights.sqlServerCheck.cacheAndWaitStats.highWaitWaitingFor }}</b> seconds
        </p>

        <p *ngIf="insights.sqlServerCheck.cacheAndWaitStats.poisonWaits" class="tooltip-indicator" matTooltip="">
          Poison waits detected. <b>{{ insights.sqlServerCheck.cacheAndWaitStats.poisonWaitType }}</b>

          <a href="https://www.brentozar.com/blitz/poison-wait-detected/">How to potentially resolve</a>
        </p>
        <p *ngIf="insights.sqlServerCheck.cacheAndWaitStats.poisonWaitsSerializableLocking">Serializable locking waits detected.</p>

        <hr />

        <p *ngIf="insights.sqlServerCheck.cacheAndWaitStats.longRunningQueryBlockingOthers">
          Long running queries are blocking others.

          {{ insights.sqlServerCheck.cacheAndWaitStats.longRunningQueryBlockingOthersDetails }}
        </p>
        <p
          *ngIf="insights.sqlServerCheck.cacheAndWaitStats.lotOfForwardedFetchesExist"
          class="tooltip-indicator"
          matTooltip="High forwarded fetches indicate inefficient index usage or fragmented tables, impacting query performance. Consider index optimization and table maintenance to reduce forwarded fetches."
        >
          Many forwarded fetches exist.
        </p>
        <p
          *ngIf="insights.sqlServerCheck.cacheAndWaitStats.lotOfCompilationsASec"
          class="tooltip-indicator"
          matTooltip="High compilations per second may indicate frequent ad-hoc query executions or plan cache churn, affecting query performance. Implement parameterized queries and optimize query plans to reduce compilation overhead."
        >
          Lots of compilations per second.
        </p>
        <p
          *ngIf="insights.sqlServerCheck.cacheAndWaitStats.lotOfReCompilationsASec"
          class="tooltip-indicator"
          matTooltip="High re-compilations per second suggest inefficient query plan caching or frequent schema changes, impacting query performance. Review query plan reuse and minimize schema changes to reduce re-compilation overhead."
        >
          Lots of re-compilations per second.
        </p>
      </mat-card-content>
    </mat-card>

    <mat-card class="mb-3">
      <mat-card-header>
        <mat-card-title>Server checks</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-tab-group>
          <mat-tab label="Data in danger">
            <div class="table-container">
              <table mat-table [dataSource]="getServerChecksData(insights.sqlServerCheck.serverIssues, ServerCheckIssueCategory.DataInDanger)" class="mat-elevation-z8">
                <ng-container matColumnDef="highPriorityError">
                  <th mat-header-cell *matHeaderCellDef></th>
                  <td mat-cell *matCellDef="let element"><mat-icon matTooltip="High Priority Warning" *ngIf="element.priority < 50" color="warn">error</mat-icon></td>
                </ng-container>

                <ng-container matColumnDef="details">
                  <th mat-header-cell *matHeaderCellDef>Details</th>
                  <td mat-cell *matCellDef="let element">{{ element.details }}</td>
                </ng-container>

                <ng-container matColumnDef="explanation">
                  <th mat-header-cell *matHeaderCellDef>Explanation</th>
                  <td mat-cell *matCellDef="let element">{{ element.scriptDetails }}</td>
                </ng-container>

                <ng-container matColumnDef="database">
                  <th mat-header-cell *matHeaderCellDef>Database Name</th>
                  <td mat-cell *matCellDef="let element">
                    <b>{{ element.databaseName }}</b>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['highPriorityError', 'details', 'explanation', 'database']; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: ['highPriorityError', 'details', 'explanation', 'database']"></tr>

                <tr class="mat-row" *matNoDataRow>
                  <td class="mat-cell text-center" colspan="4"><img class="no-data-table-image" src="assets/empty-table.png" alt="No Data Available" /></td>
                </tr>
              </table>
            </div>
          </mat-tab>
          <mat-tab label="Server in danger">
            <div class="table-container">
              <table mat-table [dataSource]="getServerChecksData(insights.sqlServerCheck.serverIssues, ServerCheckIssueCategory.ServerInDanger)" class="mat-elevation-z8">
                <ng-container matColumnDef="highPriorityError">
                  <th mat-header-cell *matHeaderCellDef></th>
                  <td mat-cell *matCellDef="let element"><mat-icon matTooltip="High Priority Warning" *ngIf="element.priority < 50" color="warn">error</mat-icon></td>
                </ng-container>
                <ng-container matColumnDef="details">
                  <th mat-header-cell *matHeaderCellDef>Details</th>
                  <td mat-cell *matCellDef="let element">{{ element.details }}</td>
                </ng-container>

                <ng-container matColumnDef="explanation">
                  <th mat-header-cell *matHeaderCellDef>Explanation</th>
                  <td mat-cell *matCellDef="let element">{{ element.scriptDetails }}</td>
                </ng-container>

                <ng-container matColumnDef="database">
                  <th mat-header-cell *matHeaderCellDef>Database Name</th>
                  <td mat-cell *matCellDef="let element">
                    <b>{{ element.databaseName }}</b>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['highPriorityError', 'details', 'explanation', 'database']; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: ['highPriorityError', 'details', 'explanation', 'database']"></tr>

                <tr class="mat-row" *matNoDataRow>
                  <td class="mat-cell text-center" colspan="4"><img class="no-data-table-image" src="assets/empty-table.png" alt="No Data Available" /></td>
                </tr>
              </table></div
          ></mat-tab>

          <mat-tab label="Server performance">
            <div class="table-container">
              <table mat-table [dataSource]="getServerChecksData(insights.sqlServerCheck.serverIssues, ServerCheckIssueCategory.ServerPerformance)" class="mat-elevation-z8">
                <ng-container matColumnDef="highPriorityError">
                  <th mat-header-cell *matHeaderCellDef></th>
                  <td mat-cell *matCellDef="let element"><mat-icon matTooltip="High Priority Warning" *ngIf="element.priority < 50" color="warn">error</mat-icon></td>
                </ng-container>
                <ng-container matColumnDef="details">
                  <th mat-header-cell *matHeaderCellDef>Details</th>
                  <td mat-cell *matCellDef="let element">{{ element.details }}</td>
                </ng-container>

                <ng-container matColumnDef="explanation">
                  <th mat-header-cell *matHeaderCellDef>Explanation</th>
                  <td mat-cell *matCellDef="let element">{{ element.scriptDetails }}</td>
                </ng-container>

                <ng-container matColumnDef="database">
                  <th mat-header-cell *matHeaderCellDef>Database Name</th>
                  <td mat-cell *matCellDef="let element">
                    <b>{{ element.databaseName }}</b>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['highPriorityError', 'details', 'explanation', 'database']; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: ['highPriorityError', 'details', 'explanation', 'database']"></tr>

                <tr class="mat-row" *matNoDataRow>
                  <td class="mat-cell text-center" colspan="4"><img class="no-data-table-image" src="assets/empty-table.png" alt="No Data Available" /></td>
                </tr>
              </table>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>

    <mat-card class="mb-3">
      <mat-card-header>
        <mat-card-title>Index Tuning</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-tab-group>
          <mat-tab label="Remove indexes">
            <div class="table-container">
              <table mat-table [dataSource]="insights.indexCheck.removeIndices" class="mat-elevation-z8">
                <ng-container matColumnDef="database">
                  <th mat-header-cell *matHeaderCellDef>Database Name</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.databaseName }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="table">
                  <th mat-header-cell *matHeaderCellDef>Table Name</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.tableName }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="index">
                  <th mat-header-cell *matHeaderCellDef>Index Name</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.index }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="explanation">
                  <th mat-header-cell *matHeaderCellDef>Explanation</th>
                  <td mat-cell *matCellDef="let element" class="tooltip-indicator" matTooltip="{{ element.message }}">{{ element.shortMessage }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['database', 'table', 'index', 'explanation']; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: ['database', 'table', 'index', 'explanation']"></tr>

                <tr class="mat-row" *matNoDataRow>
                  <td class="mat-cell text-center" colspan="4"><img class="no-data-table-image" src="assets/empty-table.png" alt="No Data Available" /></td>
                </tr>
              </table>
            </div>
          </mat-tab>
          <mat-tab label="Add indexes">
            <div class="table-container">
              <table mat-table [dataSource]="insights.indexCheck.addIndices" class="mat-elevation-z8">
                <ng-container matColumnDef="database">
                  <th mat-header-cell *matHeaderCellDef>Database Name</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.databaseName }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="table">
                  <th mat-header-cell *matHeaderCellDef>Table Name</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.tableName }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="index">
                  <th mat-header-cell *matHeaderCellDef>Index</th>
                  <td mat-cell *matCellDef="let element">
                    {{ element.indexDetails }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="impact">
                  <th mat-header-cell *matHeaderCellDef>Impact</th>
                  <td mat-cell *matCellDef="let element">{{ element.impact }}</td>
                </ng-container>

                <ng-container matColumnDef="benefit">
                  <th mat-header-cell *matHeaderCellDef>Magic benefit number</th>
                  <td mat-cell *matCellDef="let element">{{ element.magicBenefit }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['database', 'table', 'index', 'impact', 'benefit']; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: ['database', 'table', 'index', 'impact', 'benefit']"></tr>

                <tr class="mat-row" *matNoDataRow>
                  <td class="mat-cell text-center" colspan="5"><img class="no-data-table-image" src="assets/empty-table.png" alt="No Data Available" /></td>
                </tr>
              </table>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
    <mat-card class="mb-3">
      <mat-card-header>
        <mat-card-title class="tooltip-indicator" matTooltip="Metrics for the whole sql server that indicate the workload">Query Tuning</mat-card-title>
        <mat-card-subtitle
          >Today's wait type: <b>{{ insights.sqlServerPerformanceCheck.todayWaitType }}</b></mat-card-subtitle
        >
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <!-- <table mat-table [dataSource]="insights.sqlServerPerformanceCheck.topBadQueries" class="mat-elevation-z8">

            <ng-container matColumnDef="details">
              <th mat-header-cell *matHeaderCellDef>Details</th>
              <td mat-cell *matCellDef="let element">{{ element.details }}</td>
            </ng-container>

            <ng-container matColumnDef="explanation">
              <th mat-header-cell *matHeaderCellDef>Explanation</th>
              <td mat-cell *matCellDef="let element">{{ element.scriptDetails }}</td>
            </ng-container>

            <ng-container matColumnDef="database">
              <th mat-header-cell *matHeaderCellDef>Database Name</th>
              <td mat-cell *matCellDef="let element">
                <b>{{ element.databaseName }}</b>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['highPriorityError', 'details', 'explanation', 'database']; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: ['highPriorityError', 'details', 'explanation', 'database']"></tr>

            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell text-center" colspan="4"><img class="no-data-table-image" src="assets/empty-table.png" alt="No Data Available" /></td>
            </tr>
          </table> -->
        </div>
      </mat-card-content>
    </mat-card>
    }
  </div>
</div>

}

<!-- <mat-icon
matTooltip="Wait stats have been cleared recently so top waiting queries might not be correct"
*ngIf="s.sqlServerCheck.cacheAndWaitStats.waitsClearedRecently"
color="warn"
>delete_forever</mat-icon
>
<mat-icon matTooltip="No significant wait stats in latest monitoring task" *ngIf="s.sqlServerCheck.cacheAndWaitStats.noSignificantWaitStats" color="primary"
>check_circle</mat-icon
>
<mat-icon matTooltip="{{ s.sqlServerCheck.cacheAndWaitStats.poisonWaitType }}" *ngIf="s.sqlServerCheck.cacheAndWaitStats.poisonWaits" color="warn">hourglass_top</mat-icon>
<mat-icon matTooltip="SERIALIZABLE isolation level detected" *ngIf="s.sqlServerCheck.cacheAndWaitStats.poisonWaitsSerializableLocking" color="warn">read_more</mat-icon> -->
